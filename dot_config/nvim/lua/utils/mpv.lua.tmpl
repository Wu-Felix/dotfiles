local mpv = {}
local snacks=require("snacks")
{{ if ne .chezmoi.os "windows" }}
local PIPE_PATH = os.getenv("TMPDIR") .. "mpv_socket"
{{else}}
local PIPE_PATH = "\\\\.\\pipe\\mpv_socket"
{{end}}
-- å·¥å…·ï¼šæ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’è½¬ MM:SSï¼‰
local function time_fmt(t)
  if not t then return "--:--" end
  local minutes = math.floor(t / 60)
  local seconds = math.floor(t % 60)
  return string.format("%02d:%02d", minutes, seconds)
end

-- å‘é€ä»»æ„å‘½ä»¤ç»™ mpv
-- command_array æ˜¯ mpv JSON IPC å‘½ä»¤æ•°ç»„ï¼Œæ¯”å¦‚ {"set_property", "pause", true}
function mpv.send_mpv_command(command_array)
  local handle = io.open(PIPE_PATH, "r+")
  if not handle then
    snacks.notifier("Failed to connect to MPV socket: " .. PIPE_PATH, vim.log.levels.ERROR)
    return nil
  end

  local request = vim.fn.json_encode({ command = command_array })
  handle:write(request .. "\n")
  handle:flush()

  local response = handle:read("*l")
  handle:close()

  if response then
    local ok, decoded = pcall(vim.fn.json_decode, response)
    if ok and decoded and decoded.error == "success" then
      return decoded
    else
      snacks.notifier("MPV returned error: " .. (decoded and decoded.error or "unknown"), vim.log.levels.WARN)
    end
  end

  return nil
end

-- è·å–å•ä¸ªå±æ€§å€¼ï¼Œæ¯”å¦‚ "media-title", "pause"
function mpv.get_property(prop)
  local handle = io.open(PIPE_PATH, "r+")
  if not handle then
    snacks.notifier("Could not open mpv socket: " .. PIPE_PATH, vim.log.levels.ERROR)
    return nil
  end

  local request = vim.fn.json_encode({ command = { "get_property", prop } })
  handle:write(request .. "\n")
  handle:flush()

  local response = handle:read("*l")
  handle:close()

  if not response then
    snacks.notifier("No response from mpv for '" .. prop .. "'", vim.log.levels.WARN)
    return nil
  end

  local ok, decoded = pcall(vim.fn.json_decode, response)
  if not ok or not decoded or decoded.data == nil then
    snacks.notifier("Failed to parse response for '" .. prop .. "'", vim.log.levels.WARN)
    return nil
  end

  return decoded.data
end

-- ä¸€æ¬¡è¯·æ±‚å¤šä¸ªå±æ€§ï¼Œè¿”å› key-value table
function mpv.get_properties(props)
  local handle = io.open(PIPE_PATH, "r+")
  if not handle then
    snacks.notifier("Could not open mpv socket: " .. PIPE_PATH, vim.log.levels.ERROR)
    return nil
  end

  for _, prop in ipairs(props) do
    local request = vim.fn.json_encode({ command = { "get_property", prop } })
    handle:write(request .. "\n")
  end
  handle:flush()

  local results = {}
  for _, prop in ipairs(props) do
    local line = handle:read("*l")
    if line then
      local ok, decoded = pcall(vim.fn.json_decode, line)
      if ok and decoded and decoded.data ~= nil then
        results[prop] = decoded.data
      end
    end
  end

  handle:close()
  return results
end

-- è·å–å½“å‰åª’ä½“æ ‡é¢˜ï¼ˆå¸¦å‰ç¼€ï¼‰
function mpv.get_mpv_title()
  local title = mpv.get_property("media-title")
  if title then
    return "ğŸµ " .. title
  else
    return ""
  end
end

-- æ˜¾ç¤ºå½“å‰æ’­æ”¾çŠ¶æ€å’Œä¿¡æ¯
function mpv.show_title()
  local info = mpv.get_properties({ "media-title", "time-pos", "duration", "pause" })
  if not info or not info["media-title"] then
    snacks.notifier("Unable to retrieve MPV media title", vim.log.levels.ERROR)
    return
  end

  local message = string.format(
    "Now playing: %s\n %s / %s",
    info["media-title"],
    time_fmt(info["time-pos"]),
    time_fmt(info["duration"])
  )

  snacks.notifier(message, vim.log.levels.INFO)
end

function mpv.show_volume()
  local info = mpv.get_properties({ "media-title", "time-pos", "duration", "pause", "volume" })
  if not info or not info["media-title"] then
    snacks.notifier("Unable to retrieve MPV media title", vim.log.levels.ERROR)
    return
  end

  local message = string.format(
    "Volume: %d%%",
    info["volume"] or 0
  )

  snacks.notifier(message, vim.log.levels.INFO)
end

function mpv.set_speed(delta)
  local current = mpv.get_property("speed")
  if not current then
    snacks.notifier("Failed to get current speed", vim.log.levels.WARN)
    return
  end

  local new_speed = math.max(0.1, current + delta)  -- é™åˆ¶æœ€ä½é€Ÿåº¦ä¸º 0.1x
  mpv.send_mpv_command({ "set_property", "speed", new_speed })

  vim.defer_fn(function()
    local confirmed = mpv.get_property("speed")
    if confirmed then
      snacks.notifier(string.format("Playback speed: %.1fx", confirmed), vim.log.levels.INFO)
    end
  end, 100)  -- å»¶è¿Ÿä¸€ç‚¹ä»¥ç¡®ä¿è®¾ç½®ç”Ÿæ•ˆ
end

mpv.toggle_pause = function()
  mpv.send_mpv_command({ "cycle", "pause" })
end

mpv.next_track = function()
  mpv.send_mpv_command({ "playlist-next", "force" })
end

mpv.prev_track = function()
  mpv.send_mpv_command({ "playlist-prev", "force" })
end

mpv.volume_up = function()
  mpv.send_mpv_command({ "add", "volume", 10 })
end

mpv.volume_down = function()
  mpv.send_mpv_command({ "add", "volume", -10 })
end

mpv.seek_forward = function()
  mpv.send_mpv_command({ "seek", 10, "relative" }) -- å¿«è¿› 10 ç§’
end

mpv.seek_backward = function()
  mpv.send_mpv_command({ "seek", -10, "relative" }) -- å¿«é€€ 10 ç§’
end

mpv.toggle_playlist = function()
  mpv.send_mpv_command({ "script-message", "playlistmanager", "show", "playlist" })
end

vim.keymap.set("n", "<leader>m<", function()
  mpv.prev_track()
  vim.defer_fn(function()
    mpv.show_title()
  end, 300)  
end, { desc = "MPV: ä¸Šä¸€æ›²" })
vim.keymap.set("n", "<leader>m>", function()
  mpv.next_track()
  vim.defer_fn(function()
    mpv.show_title()
  end, 300)  
end, { desc = "MPV: ä¸‹ä¸€æ›²" })
vim.keymap.set("n", "<leader>mk", function()
  mpv.volume_up()
  vim.defer_fn(mpv.show_volume, 100)  
end, { desc = "MPV: éŸ³é‡+", silent = true })
vim.keymap.set("n", "<leader>mj", function()
  mpv.volume_down()
  vim.defer_fn(mpv.show_volume, 100)  
end, { desc = "MPV: éŸ³é‡-", silent = true })
vim.keymap.set("n", "<leader>mi", mpv.show_title, { desc = "MPV: æ˜¾ç¤ºå½“å‰æ­Œæ›²" })
vim.keymap.set("n", "<leader>ml", function()
  mpv.seek_forward()
  vim.defer_fn(function()
    mpv.show_title()
  end, 100)
end, { desc = "MPV: å¿«è¿› 10 ç§’", silent = true })
vim.keymap.set("n", "<leader>mh", function()
  mpv.seek_backward()
  vim.defer_fn(mpv.show_title, 100)
end, { desc = "MPV: å¿«é€€ 10 ç§’", silent = true })

vim.keymap.set("n", "<leader>mp", function()
  mpv.toggle_pause()
  vim.defer_fn(mpv.show_title, 100)
end, { desc = "MPV: æ’­æ”¾/æš‚åœåˆ‡æ¢", silent = true })
vim.keymap.set("n", "<leader>mo", mpv.toggle_playlist, {
  desc = "MPV: æ˜¾ç¤ºæ’­æ”¾åˆ—è¡¨",
})

vim.keymap.set("n", "<leader>m]", function()
  mpv.set_speed(0.1)
end, { desc = "MPV: æ’­æ”¾é€Ÿåº¦ +", silent = true })

vim.keymap.set("n", "<leader>m[", function()
  mpv.set_speed(-0.1)
end, { desc = "MPV: æ’­æ”¾é€Ÿåº¦ -", silent = true })
return mpv
